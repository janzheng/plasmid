!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@tiptap/core"),require("@tiptap/pm/state"),require("@tiptap/pm/gapcursor")):"function"==typeof define&&define.amd?define(["exports","@tiptap/core","@tiptap/pm/state","@tiptap/pm/gapcursor"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self)["@tiptap-pro/extension-details"]={},t.core,t.state,t.gapcursor)}(this,(function(t,e,n,o){"use strict";const r=(t,e)=>null!==e.view.domAtPos(t).node.offsetParent,s=(t,n)=>{const{state:s,view:i,extensionManager:a}=t,{schema:d,selection:c}=s,{empty:p,$anchor:l}=c,u=!!a.extensions.find((t=>"gapCursor"===t.name));if(!p||l.parent.type!==d.nodes.detailsSummary||!u)return!1;if("right"===n&&l.parentOffset!==l.parent.nodeSize-2)return!1;const f=e.findParentNode((t=>t.type===d.nodes.details))(c);if(!f)return!1;const m=e.findChildren(f.node,(t=>t.type===d.nodes.detailsContent));if(!m.length)return!1;if(r(f.start+m[0].pos+1,t))return!1;const h=s.doc.resolve(f.pos+f.node.nodeSize),y=o.GapCursor.findFrom(h,1,!1);if(!y)return!1;const{tr:g}=s,S=new o.GapCursor(y);return g.setSelection(S),g.scrollIntoView(),i.dispatch(g),!0},i=e.Node.create({name:"details",content:"detailsSummary detailsContent",group:"block",defining:!0,isolating:!0,allowGapCursor:!1,addOptions:()=>({persist:!1,openClassName:"is-open",HTMLAttributes:{}}),addAttributes(){return this.options.persist?{open:{default:!1,parseHTML:t=>t.hasAttribute("open"),renderHTML:({open:t})=>t?{open:""}:{}}}:[]},parseHTML:()=>[{tag:"details"}],renderHTML({HTMLAttributes:t}){return["details",e.mergeAttributes(this.options.HTMLAttributes,t),0]},addNodeView(){return({editor:t,getPos:n,node:o,HTMLAttributes:r})=>{const s=document.createElement("div"),i=e.mergeAttributes(this.options.HTMLAttributes,r,{"data-type":this.name});Object.entries(i).forEach((([t,e])=>s.setAttribute(t,e)));const a=document.createElement("button");s.append(a);const d=document.createElement("div");s.append(d);const c=()=>{s.classList.toggle(this.options.openClassName);const t=new Event("toggleDetailsContent"),e=d.querySelector(':scope > div[data-type="detailsContent"]');null==e||e.dispatchEvent(t)};return o.attrs.open&&setTimeout(c),a.addEventListener("click",(()=>{if(c(),this.options.persist){if(t.isEditable&&"function"==typeof n){const{from:e,to:o}=t.state.selection;t.chain().command((({tr:t})=>{const e=n(),o=t.doc.nodeAt(e);return(null==o?void 0:o.type)===this.type&&(t.setNodeMarkup(e,void 0,{open:!o.attrs.open}),!0)})).setTextSelection({from:e,to:o}).focus(void 0,{scrollIntoView:!1}).run()}}else t.commands.focus()})),{dom:s,contentDOM:d,ignoreMutation:t=>"selection"!==t.type&&(!s.contains(t.target)||s===t.target),update:t=>t.type===this.type}}},addCommands(){return{setDetails:()=>({state:t,chain:e})=>{var n;const{schema:o,selection:r}=t,{$from:s,$to:i}=r,a=s.blockRange(i);if(!a)return!1;const d=t.doc.slice(a.start,a.end);if(!o.nodes.detailsContent.contentMatch.matchFragment(d.content))return!1;const c=(null===(n=d.toJSON())||void 0===n?void 0:n.content)||[];return e().insertContentAt({from:a.start,to:a.end},{type:this.name,content:[{type:"detailsSummary"},{type:"detailsContent",content:c}]}).setTextSelection(a.start+2).run()},unsetDetails:()=>({state:t,chain:n})=>{const{selection:o,schema:r}=t,s=e.findParentNode((t=>t.type===this.type))(o);if(!s)return!1;const i=e.findChildren(s.node,(t=>t.type===r.nodes.detailsSummary)),a=e.findChildren(s.node,(t=>t.type===r.nodes.detailsContent));if(!i.length||!a.length)return!1;const d=i[0],c=a[0],p=s.pos,l=t.doc.resolve(p),u={from:p,to:p+s.node.nodeSize},f=c.node.content.toJSON()||[],m=l.parent.type.contentMatch.defaultType,h=[null==m?void 0:m.create(null,d.node.content).toJSON(),...f];return n().insertContentAt(u,h).setTextSelection(p+1).run()}}},addKeyboardShortcuts(){return{Backspace:()=>{const{schema:t,selection:e}=this.editor.state,{empty:n,$anchor:o}=e;return!(!n||o.parent.type!==t.nodes.detailsSummary)&&(0!==o.parentOffset?this.editor.commands.command((({tr:t})=>{const e=o.pos-1,n=o.pos;return t.delete(e,n),!0})):this.editor.commands.unsetDetails())},Enter:({editor:t})=>{const{state:o,view:s}=t,{schema:i,selection:a}=o,{$head:d}=a;if(d.parent.type!==i.nodes.detailsSummary)return!1;const c=r(d.after()+1,t),p=c?o.doc.nodeAt(d.after()):d.node(-2);if(!p)return!1;const l=c?0:d.indexAfter(-1),u=e.defaultBlockAt(p.contentMatchAt(l));if(!u||!p.canReplaceWith(l,l,u))return!1;const f=u.createAndFill();if(!f)return!1;const m=c?d.after()+1:d.after(-1),h=o.tr.replaceWith(m,m,f),y=h.doc.resolve(m),g=n.Selection.near(y,1);return h.setSelection(g),h.scrollIntoView(),s.dispatch(h),!0},ArrowRight:({editor:t})=>s(t,"right"),ArrowDown:({editor:t})=>s(t,"down")}},addProseMirrorPlugins(){return[new n.Plugin({key:new n.PluginKey("detailsSelection"),appendTransaction:(t,o,s)=>{const{editor:i,type:a}=this,d=t.some((t=>t.selectionSet));if(!d||!o.selection.empty||!s.selection.empty)return;if(!e.isActive(s,a.name))return;const{$from:c}=s.selection;if(r(c.pos,i))return;const p=((t,e,n)=>{for(let o=t.depth;o>0;o-=1){const s=t.node(o),i=e(s),a=r(t.start(o),n);if(i&&a)return{pos:o>0?t.before(o):0,start:t.start(o),depth:o,node:s}}})(c,(t=>t.type===a),i);if(!p)return;const l=e.findChildren(p.node,(t=>t.type===s.schema.nodes.detailsSummary));if(!l.length)return;const u=l[0],f="forward"===(o.selection.from<s.selection.from?"forward":"backward")?p.start+u.pos:p.pos+u.pos+u.node.nodeSize,m=n.TextSelection.create(s.doc,f);return s.tr.setSelection(m)}})]}});t.Details=i,t.default=i,Object.defineProperty(t,"__esModule",{value:!0})}));
