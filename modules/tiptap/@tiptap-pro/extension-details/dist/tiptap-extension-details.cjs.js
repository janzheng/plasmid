"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("@tiptap/core"),e=require("@tiptap/pm/state"),n=require("@tiptap/pm/gapcursor");const o=(t,e)=>null!==e.view.domAtPos(t).node.offsetParent,r=(e,r)=>{const{state:s,view:i,extensionManager:a}=e,{schema:d,selection:c}=s,{empty:l,$anchor:p}=c,u=!!a.extensions.find((t=>"gapCursor"===t.name));if(!l||p.parent.type!==d.nodes.detailsSummary||!u)return!1;if("right"===r&&p.parentOffset!==p.parent.nodeSize-2)return!1;const m=t.findParentNode((t=>t.type===d.nodes.details))(c);if(!m)return!1;const f=t.findChildren(m.node,(t=>t.type===d.nodes.detailsContent));if(!f.length)return!1;if(o(m.start+f[0].pos+1,e))return!1;const h=s.doc.resolve(m.pos+m.node.nodeSize),y=n.GapCursor.findFrom(h,1,!1);if(!y)return!1;const{tr:g}=s,S=new n.GapCursor(y);return g.setSelection(S),g.scrollIntoView(),i.dispatch(g),!0},s=t.Node.create({name:"details",content:"detailsSummary detailsContent",group:"block",defining:!0,isolating:!0,allowGapCursor:!1,addOptions:()=>({persist:!1,openClassName:"is-open",HTMLAttributes:{}}),addAttributes(){return this.options.persist?{open:{default:!1,parseHTML:t=>t.hasAttribute("open"),renderHTML:({open:t})=>t?{open:""}:{}}}:[]},parseHTML:()=>[{tag:"details"}],renderHTML({HTMLAttributes:e}){return["details",t.mergeAttributes(this.options.HTMLAttributes,e),0]},addNodeView(){return({editor:e,getPos:n,node:o,HTMLAttributes:r})=>{const s=document.createElement("div"),i=t.mergeAttributes(this.options.HTMLAttributes,r,{"data-type":this.name});Object.entries(i).forEach((([t,e])=>s.setAttribute(t,e)));const a=document.createElement("button");s.append(a);const d=document.createElement("div");s.append(d);const c=()=>{s.classList.toggle(this.options.openClassName);const t=new Event("toggleDetailsContent"),e=d.querySelector(':scope > div[data-type="detailsContent"]');null==e||e.dispatchEvent(t)};return o.attrs.open&&setTimeout(c),a.addEventListener("click",(()=>{if(c(),this.options.persist){if(e.isEditable&&"function"==typeof n){const{from:t,to:o}=e.state.selection;e.chain().command((({tr:t})=>{const e=n(),o=t.doc.nodeAt(e);return(null==o?void 0:o.type)===this.type&&(t.setNodeMarkup(e,void 0,{open:!o.attrs.open}),!0)})).setTextSelection({from:t,to:o}).focus(void 0,{scrollIntoView:!1}).run()}}else e.commands.focus()})),{dom:s,contentDOM:d,ignoreMutation:t=>"selection"!==t.type&&(!s.contains(t.target)||s===t.target),update:t=>t.type===this.type}}},addCommands(){return{setDetails:()=>({state:t,chain:e})=>{var n;const{schema:o,selection:r}=t,{$from:s,$to:i}=r,a=s.blockRange(i);if(!a)return!1;const d=t.doc.slice(a.start,a.end);if(!o.nodes.detailsContent.contentMatch.matchFragment(d.content))return!1;const c=(null===(n=d.toJSON())||void 0===n?void 0:n.content)||[];return e().insertContentAt({from:a.start,to:a.end},{type:this.name,content:[{type:"detailsSummary"},{type:"detailsContent",content:c}]}).setTextSelection(a.start+2).run()},unsetDetails:()=>({state:e,chain:n})=>{const{selection:o,schema:r}=e,s=t.findParentNode((t=>t.type===this.type))(o);if(!s)return!1;const i=t.findChildren(s.node,(t=>t.type===r.nodes.detailsSummary)),a=t.findChildren(s.node,(t=>t.type===r.nodes.detailsContent));if(!i.length||!a.length)return!1;const d=i[0],c=a[0],l=s.pos,p=e.doc.resolve(l),u={from:l,to:l+s.node.nodeSize},m=c.node.content.toJSON()||[],f=p.parent.type.contentMatch.defaultType,h=[null==f?void 0:f.create(null,d.node.content).toJSON(),...m];return n().insertContentAt(u,h).setTextSelection(l+1).run()}}},addKeyboardShortcuts(){return{Backspace:()=>{const{schema:t,selection:e}=this.editor.state,{empty:n,$anchor:o}=e;return!(!n||o.parent.type!==t.nodes.detailsSummary)&&(0!==o.parentOffset?this.editor.commands.command((({tr:t})=>{const e=o.pos-1,n=o.pos;return t.delete(e,n),!0})):this.editor.commands.unsetDetails())},Enter:({editor:n})=>{const{state:r,view:s}=n,{schema:i,selection:a}=r,{$head:d}=a;if(d.parent.type!==i.nodes.detailsSummary)return!1;const c=o(d.after()+1,n),l=c?r.doc.nodeAt(d.after()):d.node(-2);if(!l)return!1;const p=c?0:d.indexAfter(-1),u=t.defaultBlockAt(l.contentMatchAt(p));if(!u||!l.canReplaceWith(p,p,u))return!1;const m=u.createAndFill();if(!m)return!1;const f=c?d.after()+1:d.after(-1),h=r.tr.replaceWith(f,f,m),y=h.doc.resolve(f),g=e.Selection.near(y,1);return h.setSelection(g),h.scrollIntoView(),s.dispatch(h),!0},ArrowRight:({editor:t})=>r(t,"right"),ArrowDown:({editor:t})=>r(t,"down")}},addProseMirrorPlugins(){return[new e.Plugin({key:new e.PluginKey("detailsSelection"),appendTransaction:(n,r,s)=>{const{editor:i,type:a}=this,d=n.some((t=>t.selectionSet));if(!d||!r.selection.empty||!s.selection.empty)return;if(!t.isActive(s,a.name))return;const{$from:c}=s.selection;if(o(c.pos,i))return;const l=((t,e,n)=>{for(let r=t.depth;r>0;r-=1){const s=t.node(r),i=e(s),a=o(t.start(r),n);if(i&&a)return{pos:r>0?t.before(r):0,start:t.start(r),depth:r,node:s}}})(c,(t=>t.type===a),i);if(!l)return;const p=t.findChildren(l.node,(t=>t.type===s.schema.nodes.detailsSummary));if(!p.length)return;const u=p[0],m="forward"===(r.selection.from<s.selection.from?"forward":"backward")?l.start+u.pos:l.pos+u.pos+u.node.nodeSize,f=e.TextSelection.create(s.doc,m);return s.tr.setSelection(f)}})]}});exports.Details=s,exports.default=s;
