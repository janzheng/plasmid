"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("@tiptap/core"),e=require("uuid"),o=require("@tiptap/pm/state");const s=({getId:t,headingType:s="heading"})=>new o.Plugin({key:new o.PluginKey("tableOfContent"),appendTransaction(o,n,i){const a=i.tr;let d=!1;if(o.some((t=>t.docChanged))){const o=[];i.doc.descendants(((n,i)=>{const r=n.attrs["data-toc-id"];if(n.type.name===s){if(null==r||o.includes(r)){let o="";o=t?t(n.textContent):e.v4(),a.setNodeMarkup(i,void 0,{...n.attrs,"data-toc-id":o,id:o}),d=!0}o.push(r)}}))}return d?a:null}}),n=(t,e)=>{let o=t.filter((t=>t.level===e)).pop();if(0!==e)return o||(o=n(t,e-1)),o},i=t=>{const{editor:e,onUpdate:o}=t;let s=[];const i=[];let a=null;e.state.doc.descendants(((o,s)=>{if(o.type.name!==(t.headingType||"heading"))return;const n=e.view.domAtPos(s+1).node;t.storage.scrollPosition>=n.offsetTop&&(a=o.attrs["data-toc-id"])})),e.state.doc.descendants(((o,d)=>{if(o.type.name!==(t.headingType||"heading"))return;const r=e.view.domAtPos(d+1).node;i.push(r);const l=t.storage.scrollPosition>=r.offsetTop,p=n(s,o.attrs.level),c=a===o.attrs["data-toc-id"];let h=1,g=1;const u=o.attrs.level;p&&(h=p.originalLevel<u?p.level+1:p.level);const v=[...s].pop();v&&v.level<h?g=1:p&&p.level===h&&(g=p.itemIndex+1),s=[...s,{itemIndex:g,id:o.attrs["data-toc-id"],originalLevel:u,level:h,textContent:o.textContent,pos:d,editor:e,isActive:c,isScrolledOver:l,node:o,dom:r}]})),o&&o(s),t.storage.headlines=i,t.storage.content=s,e.state.tr.setMeta("toc",s),e.view.dispatch(e.state.tr)},a=t.Extension.create({name:"tableOfContent",addStorage:()=>({content:[],headlines:[],scrollHandler:()=>null,scrollPosition:0}),addGlobalAttributes(){return[{types:[this.options.headingType||"heading"],attributes:{id:{default:null,renderHTML:t=>({id:t.id}),parseHTML:t=>t.id||null},"data-toc-id":{default:null,renderHTML:t=>({"data-toc-id":t["data-toc-id"]}),parseHTML:t=>t.dataset.tocId||null}}}]},addOptions:()=>({onUpdate:()=>{},getId:t=>e.v4(),scrollParent:"undefined"!=typeof window&&window||void 0,headingType:"heading"}),onUpdate(){i({editor:this.editor,storage:this.storage,onUpdate:this.options.onUpdate,headingType:this.options.headingType})},onCreate(){const{tr:t}=this.editor.state,o=[];this.editor.state.doc.descendants(((s,n)=>{const i=s.attrs["data-toc-id"];if(s.type.name===this.options.headingType){if(null==i||o.includes(i)){let o="";o=this.options.getId?this.options.getId(s.textContent):e.v4(),t.setNodeMarkup(n,void 0,{...s.attrs,"data-toc-id":o,id:o})}o.push(i)}})),this.editor.view.dispatch(t),i({editor:this.editor,storage:this.storage,onUpdate:this.options.onUpdate,headingType:this.options.headingType}),this.storage.scrollHandler=()=>{var t;const e=this.options.scrollParent instanceof HTMLElement?this.options.scrollParent.scrollTop:null===(t=this.options.scrollParent)||void 0===t?void 0:t.scrollY;this.storage.scrollPosition=e||0,i({editor:this.editor,storage:this.storage,onUpdate:this.options.onUpdate,headingType:this.options.headingType})},this.options.scrollParent&&this.options.scrollParent.addEventListener("scroll",this.storage.scrollHandler)},onDestroy(){this.options.scrollParent&&this.options.scrollParent.removeEventListener("scroll",this.storage.scrollHandler)},addProseMirrorPlugins(){return[s({getId:this.options.getId,headingType:this.options.headingType})]}});exports.TableOfContent=a,exports.TableOfContentPlugin=s,exports.default=a;
