"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("@tiptap/core"),e=require("@tiptap/pm/state"),n=require("@tiptap/pm/model"),r=require("uuid");function o(t){return function(t,e=JSON.stringify){const n={};return t.filter((t=>{const r=e(t);return!Object.prototype.hasOwnProperty.call(n,r)&&(n[r]=!0)}))}(t.filter(((e,n)=>t.indexOf(e)!==n)))}const i=t.Extension.create({name:"uniqueID",priority:1e4,addOptions:()=>({attributeName:"id",types:[],generateID:()=>r.v4(),filterTransaction:null}),addGlobalAttributes(){return[{types:this.options.types,attributes:{[this.options.attributeName]:{default:null,parseHTML:t=>t.getAttribute(`data-${this.options.attributeName}`),renderHTML:t=>t[this.options.attributeName]?{[`data-${this.options.attributeName}`]:t[this.options.attributeName]}:{}}}}]},onCreate(){if(this.editor.extensionManager.extensions.find((t=>"collaboration"===t.name)))return;const{view:e,state:n}=this.editor,{tr:r,doc:o}=n,{types:i,attributeName:a,generateID:s}=this.options;t.findChildren(o,(t=>i.includes(t.type.name)&&null===t.attrs[a])).forEach((({node:t,pos:e})=>{r.setNodeMarkup(e,void 0,{...t.attrs,[a]:s()})})),r.setMeta("addToHistory",!1),e.dispatch(r)},addProseMirrorPlugins(){let r=null,i=!1;return[new e.Plugin({key:new e.PluginKey("uniqueID"),appendTransaction:(e,n,r)=>{const i=e.some((t=>t.docChanged))&&!n.doc.eq(r.doc),a=this.options.filterTransaction&&e.some((t=>{var e,n;return!(null===(n=(e=this.options).filterTransaction)||void 0===n?void 0:n.call(e,t))}));if(!i||a)return;const{tr:s}=r,{types:d,attributeName:u,generateID:p}=this.options,l=t.combineTransactionSteps(n.doc,e),{mapping:c}=l;return t.getChangedRanges(l).forEach((({newRange:e})=>{const n=t.findChildrenInRange(r.doc,e,(t=>d.includes(t.type.name))),i=n.map((({node:t})=>t.attrs[u])).filter((t=>null!==t));n.forEach((({node:t,pos:e},r)=>{var a;const d=null===(a=s.doc.nodeAt(e))||void 0===a?void 0:a.attrs[u];if(null===d)return void s.setNodeMarkup(e,void 0,{...t.attrs,[u]:p()});const l=n[r+1];if(l&&0===t.content.size){s.setNodeMarkup(l.pos,void 0,{...l.node.attrs,[u]:d}),i[r+1]=d;const n=p();return s.setNodeMarkup(e,void 0,{...t.attrs,[u]:n}),i[r]=n,s}const m=o(i),{deleted:f}=c.invert().mapResult(e);f&&m.includes(d)&&s.setNodeMarkup(e,void 0,{...t.attrs,[u]:p()})}))})),s.steps.length?s:void 0},view(t){const e=e=>{var n;r=(null===(n=t.dom.parentElement)||void 0===n?void 0:n.contains(e.target))?t.dom.parentElement:null};return window.addEventListener("dragstart",e),{destroy(){window.removeEventListener("dragstart",e)}}},props:{handleDOMEvents:{drop:(t,e)=>{var n;return r===t.dom.parentElement&&"copy"!==(null===(n=e.dataTransfer)||void 0===n?void 0:n.effectAllowed)||(r=null,i=!0),!1},paste:()=>(i=!0,!1)},transformPasted:t=>{if(!i)return t;const{types:e,attributeName:r}=this.options,o=t=>{const i=[];return t.forEach((t=>{if(t.isText)return void i.push(t);if(!e.includes(t.type.name))return void i.push(t.copy(o(t.content)));const n=t.type.create({...t.attrs,[r]:null},o(t.content),t.marks);i.push(n)})),n.Fragment.from(i)};return i=!1,new n.Slice(o(t.content),t.openStart,t.openEnd)}}})]}});exports.UniqueID=i,exports.default=i;
