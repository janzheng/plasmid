!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@tiptap/core"),require("@tiptap/pm/state"),require("@tiptap/pm/model"),require("uuid")):"function"==typeof define&&define.amd?define(["exports","@tiptap/core","@tiptap/pm/state","@tiptap/pm/model","uuid"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self)["@tiptap-pro/extension-unique-id"]={},t.core,t.state,t.model,t.uuid)}(this,(function(t,e,n,o,r){"use strict";function i(t){return function(t,e=JSON.stringify){const n={};return t.filter((t=>{const o=e(t);return!Object.prototype.hasOwnProperty.call(n,o)&&(n[o]=!0)}))}(t.filter(((e,n)=>t.indexOf(e)!==n)))}const a=e.Extension.create({name:"uniqueID",priority:1e4,addOptions:()=>({attributeName:"id",types:[],generateID:()=>r.v4(),filterTransaction:null}),addGlobalAttributes(){return[{types:this.options.types,attributes:{[this.options.attributeName]:{default:null,parseHTML:t=>t.getAttribute(`data-${this.options.attributeName}`),renderHTML:t=>t[this.options.attributeName]?{[`data-${this.options.attributeName}`]:t[this.options.attributeName]}:{}}}}]},onCreate(){if(this.editor.extensionManager.extensions.find((t=>"collaboration"===t.name)))return;const{view:t,state:n}=this.editor,{tr:o,doc:r}=n,{types:i,attributeName:a,generateID:s}=this.options;e.findChildren(r,(t=>i.includes(t.type.name)&&null===t.attrs[a])).forEach((({node:t,pos:e})=>{o.setNodeMarkup(e,void 0,{...t.attrs,[a]:s()})})),o.setMeta("addToHistory",!1),t.dispatch(o)},addProseMirrorPlugins(){let t=null,r=!1;return[new n.Plugin({key:new n.PluginKey("uniqueID"),appendTransaction:(t,n,o)=>{const r=t.some((t=>t.docChanged))&&!n.doc.eq(o.doc),a=this.options.filterTransaction&&t.some((t=>{var e,n;return!(null===(n=(e=this.options).filterTransaction)||void 0===n?void 0:n.call(e,t))}));if(!r||a)return;const{tr:s}=o,{types:d,attributeName:u,generateID:p}=this.options,l=e.combineTransactionSteps(n.doc,t),{mapping:c}=l;return e.getChangedRanges(l).forEach((({newRange:t})=>{const n=e.findChildrenInRange(o.doc,t,(t=>d.includes(t.type.name))),r=n.map((({node:t})=>t.attrs[u])).filter((t=>null!==t));n.forEach((({node:t,pos:e},o)=>{var a;const d=null===(a=s.doc.nodeAt(e))||void 0===a?void 0:a.attrs[u];if(null===d)return void s.setNodeMarkup(e,void 0,{...t.attrs,[u]:p()});const l=n[o+1];if(l&&0===t.content.size){s.setNodeMarkup(l.pos,void 0,{...l.node.attrs,[u]:d}),r[o+1]=d;const n=p();return s.setNodeMarkup(e,void 0,{...t.attrs,[u]:n}),r[o]=n,s}const f=i(r),{deleted:m}=c.invert().mapResult(e);m&&f.includes(d)&&s.setNodeMarkup(e,void 0,{...t.attrs,[u]:p()})}))})),s.steps.length?s:void 0},view(e){const n=n=>{var o;t=(null===(o=e.dom.parentElement)||void 0===o?void 0:o.contains(n.target))?e.dom.parentElement:null};return window.addEventListener("dragstart",n),{destroy(){window.removeEventListener("dragstart",n)}}},props:{handleDOMEvents:{drop:(e,n)=>{var o;return t===e.dom.parentElement&&"copy"!==(null===(o=n.dataTransfer)||void 0===o?void 0:o.effectAllowed)||(t=null,r=!0),!1},paste:()=>(r=!0,!1)},transformPasted:t=>{if(!r)return t;const{types:e,attributeName:n}=this.options,i=t=>{const r=[];return t.forEach((t=>{if(t.isText)return void r.push(t);if(!e.includes(t.type.name))return void r.push(t.copy(i(t.content)));const o=t.type.create({...t.attrs,[n]:null},i(t.content),t.marks);r.push(o)})),o.Fragment.from(r)};return r=!1,new o.Slice(i(t.content),t.openStart,t.openEnd)}}})]}});t.UniqueID=a,t.default=a,Object.defineProperty(t,"__esModule",{value:!0})}));
